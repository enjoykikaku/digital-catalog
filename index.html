<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>エンジョイホーム デジタルカタログ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="./turn.min.js"></script>
  <style>
    body { margin: 0; background: #222; overflow: hidden; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; }
    #flipbook { visibility: hidden; margin: 0 auto; }
    .page { background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    canvas { width: 100%; height: 100%; display: block; }
    #loader { color: white; position: absolute; font-family: sans-serif; }
  </style>
</head>
<body>
  <div id="loader">カタログを生成中...</div>
  <div id="flipbook"></div>

  <script>
    const url = './catalog.pdf';
    // Workerの指定をcdnjs経由に固定して安定化
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    function isWide() { return window.innerWidth > 900; }

    async function buildFlipbook() {
      try {
        const flipbook = $('#flipbook');
        const pdf = await pdfjsLib.getDocument(url).promise;
        const totalPages = pdf.numPages;

        // まず表紙のサイズを取得して本全体の比率を決める
        const firstPage = await pdf.getPage(1);
        const firstViewport = firstPage.getViewport({ scale: 1.0 });
        const aspect = firstViewport.width / firstViewport.height;

        // 画面に収まるサイズを計算
        const bookH = window.innerHeight * 0.9;
        const bookW = isWide() ? (bookH * aspect) * 2 : (bookH * aspect);

        // 各ページ（枠）を作成
        for (let i = 1; i <= totalPages; i++) {
          const pageDiv = $('<div class="page"></div>').attr('data-page', i);
          flipbook.append(pageDiv);
        }

        // turn.js 初期化
        $('#loader').hide();
        flipbook.width(bookW).height(bookH).css('visibility', 'visible').turn({
          width: bookW,
          height: bookH,
          autoCenter: true,
          display: isWide() ? 'double' : 'single',
          acceleration: true,
          elevation: 50,
          when: {
            turning: async function(e, page, view) {
              // 見えているページだけを描画（もっさり解消）
              view.forEach(async (p) => {
                if (p === 0) return;
                const container = $(`.page[data-page="${p}"]`);
                if (container.find('canvas').length === 0) {
                  const pdfPage = await pdf.getPage(p);
                  const viewport = pdfPage.getViewport({ scale: 2.0 }); // 高画質化
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  canvas.width = viewport.width;
                  canvas.height = viewport.height;
                  await pdfPage.render({ canvasContext: ctx, viewport }).promise;
                  container.append(canvas);
                }
              });
            }
          }
        });

        // 1ページ目を手動で描画開始
        flipbook.turn('page', 1);

      } catch (err) {
        console.error(err);
        $('#loader').text('読み込みエラー。再読み込みしてください。');
      }
    }

    $(window).on('load', buildFlipbook);
  </script>
</body>
</html>
